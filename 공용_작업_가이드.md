# 노트북-PC 공용 작업 가이드

## 1. 개요

이 문서는 노트북(Mac)과 PC(Windows) 간의 공통 작업 항목에 대한 가이드입니다. 두 시스템이 함께 작동하기 위해 필요한 공통 설정, 프로토콜, 데이터 형식 등을 정의합니다.

## 2. 공통 파일 구조

### 2.1 공통으로 사용할 파일

```
프로젝트 루트/
├── config.py              # 공통 설정 관리 (노트북, PC 모두 사용)
├── .env.example           # 환경 변수 예시 템플릿
├── requirements.txt      # 공통 Python 패키지 의존성
└── 공용_작업_가이드.md   # 이 문서
```

### 2.2 노트북 전용 파일

```
프로젝트 루트/
├── db_connector.py       # PostgreSQL DB 연결 및 쿼리
├── prompt_builder.py     # DB 데이터로부터 프롬프트 생성
├── model_api_client.py   # PC의 API 서버에 요청 전송
└── db_to_model_pipeline.py  # 전체 파이프라인 오케스트레이션
```

### 2.3 PC 전용 파일

```
프로젝트 루트/
├── model_api_server.py   # FastAPI 기반 모델 서버
└── phi4_server.py       # 기존 모델 실행 스크립트 (수정)
```

## 3. 공통 설정 파일

### 3.1 `config.py` 구조

```python
"""
공통 설정 관리 모듈
노트북과 PC 모두에서 사용
"""
import os
from dotenv import load_dotenv

# .env 파일 로드
load_dotenv()

class Config:
    """공통 설정 클래스"""
    
    # API 서버 설정 (PC)
    API_HOST = os.getenv("API_HOST", "0.0.0.0")
    API_PORT = int(os.getenv("API_PORT", 8000))
    API_BASE_URL = os.getenv("API_BASE_URL", f"http://{API_HOST}:{API_PORT}")
    
    # 모델 설정
    MODEL_TYPE = os.getenv("MODEL_TYPE", "phi4-quantized")
    MODEL_DIR = os.getenv("MODEL_DIR", None)
    MAX_NEW_TOKENS = int(os.getenv("MAX_NEW_TOKENS", 512))
    TEMPERATURE = float(os.getenv("TEMPERATURE", 0.7))
    
    # DB 설정 (노트북)
    DB_HOST = os.getenv("DB_HOST", "localhost")
    DB_PORT = int(os.getenv("DB_PORT", 5432))
    DB_NAME = os.getenv("DB_NAME", "your_database")
    DB_USER = os.getenv("DB_USER", "your_user")
    DB_PASSWORD = os.getenv("DB_PASSWORD", "your_password")
    
    # 네트워크 설정
    PC_IP = os.getenv("PC_IP", "192.168.0.XXX")  # PC의 로컬 IP
    LAPTOP_IP = os.getenv("LAPTOP_IP", "192.168.0.YYY")  # 노트북의 로컬 IP
    
    # 타임아웃 설정
    API_TIMEOUT = int(os.getenv("API_TIMEOUT", 300))  # 5분
    
    @classmethod
    def get_api_url(cls):
        """PC API 서버의 전체 URL 반환"""
        return f"http://{cls.PC_IP}:{cls.API_PORT}"
    
    @classmethod
    def get_db_connection_string(cls):
        """DB 연결 문자열 반환"""
        return f"postgresql://{cls.DB_USER}:{cls.DB_PASSWORD}@{cls.DB_HOST}:{cls.DB_PORT}/{cls.DB_NAME}"
```

### 3.2 `.env.example` 구조

```bash
# ============================================
# 공통 설정 (노트북, PC 모두 사용)
# ============================================

# 모델 설정
MODEL_TYPE=phi4-quantized
MODEL_DIR=
MAX_NEW_TOKENS=512
TEMPERATURE=0.7

# ============================================
# PC 전용 설정
# ============================================

# API 서버 설정
API_HOST=0.0.0.0
API_PORT=8000

# ============================================
# 노트북 전용 설정
# ============================================

# DB 설정
DB_HOST=localhost
DB_PORT=5432
DB_NAME=your_database
DB_USER=your_user
DB_PASSWORD=your_password

# 네트워크 설정
PC_IP=192.168.0.XXX  # PC의 로컬 IP 주소
LAPTOP_IP=192.168.0.YYY  # 노트북의 로컬 IP 주소

# API 클라이언트 설정
API_TIMEOUT=300  # 초 단위
```

## 4. API 통신 프로토콜

### 4.1 API 엔드포인트

**기본 URL**: `http://{PC_IP}:{API_PORT}`

#### 4.1.1 `POST /api/generate`

**목적**: 프롬프트를 받아 모델로 처리하고 답변 반환

**요청 형식**:
```json
{
  "prompt": "사용자 프롬프트 텍스트",
  "system_prompt": "시스템 프롬프트 (선택사항)",
  "max_new_tokens": 512,
  "temperature": 0.7
}
```

**응답 형식 (성공)**:
```json
{
  "response": "모델이 생성한 답변 텍스트",
  "stats": {
    "generation_time": 2.5,
    "input_tokens": 100,
    "generated_tokens": 200,
    "tokens_per_second": 80.0
  }
}
```

**응답 형식 (오류)**:
```json
{
  "detail": "오류 메시지"
}
```

**HTTP 상태 코드**:
- `200`: 성공
- `400`: 잘못된 요청 (프롬프트 누락 등)
- `500`: 서버 내부 오류

#### 4.1.2 `GET /api/health`

**목적**: 서버 상태 확인

**요청**: 없음

**응답 형식**:
```json
{
  "status": "healthy",
  "model_loaded": true
}
```

**HTTP 상태 코드**:
- `200`: 서버 정상
- `503`: 서버 비정상 (모델 미로드 등)

### 4.2 요청/응답 예시

#### Python `requests` 사용 예시

```python
import requests
from config import Config

# 프롬프트 전송
url = f"{Config.get_api_url()}/api/generate"
payload = {
    "prompt": "안녕하세요",
    "max_new_tokens": 100,
    "temperature": 0.7
}

response = requests.post(url, json=payload, timeout=Config.API_TIMEOUT)

if response.status_code == 200:
    data = response.json()
    print(f"답변: {data['response']}")
    print(f"생성 시간: {data['stats']['generation_time']}초")
else:
    print(f"오류: {response.status_code} - {response.text}")
```

#### curl 사용 예시

```bash
# 서버 상태 확인
curl http://192.168.0.XXX:8000/api/health

# 프롬프트 전송
curl -X POST http://192.168.0.XXX:8000/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "안녕하세요",
    "max_new_tokens": 100,
    "temperature": 0.7
  }'
```

## 5. 데이터 형식 정의

### 5.1 프롬프트 형식

**기본 구조**:
```
[시스템 프롬프트 (선택사항)]

[사용자 프롬프트]
```

**예시**:
```
당신은 데이터 분석 전문가입니다.

다음 데이터를 분석해주세요:
- 매출: 100만원
- 고객 수: 50명
```

### 5.2 DB 쿼리 결과 형식

**표준 형식**:
```python
{
    "query": "SELECT * FROM table",
    "results": [
        {"column1": "value1", "column2": "value2"},
        {"column1": "value3", "column2": "value4"}
    ],
    "row_count": 2
}
```

### 5.3 프롬프트 빌더 입력 형식

```python
{
    "db_data": {
        "query": "SELECT * FROM sales",
        "results": [...],
        "row_count": 10
    },
    "template": "다음 데이터를 분석해주세요: {data}",
    "additional_context": "추가 컨텍스트 정보"
}
```

## 6. 공통 의존성 패키지

### 6.1 `requirements.txt` 구조

```txt
# ============================================
# 공통 패키지 (노트북, PC 모두 필요)
# ============================================

# 환경 변수 관리
python-dotenv>=1.0.0

# HTTP 요청 (노트북에서 PC로 요청 전송)
requests>=2.31.0

# ============================================
# 노트북 전용 패키지
# ============================================

# PostgreSQL 연결
psycopg2-binary>=2.9.0

# ============================================
# PC 전용 패키지
# ============================================

# FastAPI 서버
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
pydantic>=2.0.0

# ============================================
# 모델 실행 패키지 (PC만 필요)
# ============================================

# PyTorch 및 Transformers
torch>=2.0.0
transformers>=4.35.0
bitsandbytes>=0.41.0
accelerate>=0.24.0
```

### 6.2 플랫폼별 설치

**노트북 (Mac)**:
```bash
pip install python-dotenv requests psycopg2-binary
```

**PC (Windows)**:
```bash
pip install python-dotenv requests fastapi uvicorn[standard] pydantic
pip install torch transformers bitsandbytes accelerate
```

## 7. 네트워크 설정 가이드

### 7.1 IP 주소 확인

**노트북 (Mac)**:
```bash
# WiFi IP 주소 확인
ifconfig | grep "inet " | grep -v 127.0.0.1
```

**PC (Windows)**:
```powershell
# 로컬 IP 주소 확인
ipconfig | findstr "IPv4"
```

### 7.2 네트워크 연결 테스트

**노트북에서 PC로**:
```bash
# PC의 API 서버 포트 확인
curl http://192.168.0.XXX:8000/api/health
```

**PC에서 노트북으로**:
```powershell
# 노트북의 DB 포트 확인 (선택사항)
Test-NetConnection -ComputerName 192.168.0.YYY -Port 5432
```

### 7.3 방화벽 설정

**PC (Windows)**:
```powershell
# API 서버 포트(8000) - 로컬 네트워크만 허용
New-NetFirewallRule -DisplayName "Model-API-Server" `
  -Direction Inbound -LocalPort 8000 -Protocol TCP `
  -RemoteAddress 192.168.0.0/24 -Action Allow
```

**노트북 (Mac)**:
```bash
# PostgreSQL 포트(5432) - 외부 접근 허용 (선택사항)
# pfctl을 사용한 방화벽 설정 (필요 시)
```

## 8. 환경 변수 설정 방법

### 8.1 노트북에서 `.env` 파일 생성

```bash
# 프로젝트 루트 디렉토리에서
cp .env.example .env

# .env 파일 편집
nano .env  # 또는 vim, VS Code 등
```

**노트북 `.env` 예시**:
```bash
# 모델 설정
MODEL_TYPE=phi4-quantized
MAX_NEW_TOKENS=512
TEMPERATURE=0.7

# DB 설정
DB_HOST=localhost
DB_PORT=5432
DB_NAME=my_database
DB_USER=my_user
DB_PASSWORD=my_password

# 네트워크 설정
PC_IP=192.168.0.100  # PC의 실제 IP
LAPTOP_IP=192.168.0.200  # 노트북의 실제 IP

# API 클라이언트 설정
API_TIMEOUT=300
```

### 8.2 PC에서 `.env` 파일 생성

```powershell
# 프로젝트 루트 디렉토리에서
Copy-Item .env.example .env

# .env 파일 편집
notepad .env  # 또는 VS Code 등
```

**PC `.env` 예시**:
```bash
# 모델 설정
MODEL_TYPE=phi4-quantized
MODEL_DIR=
MAX_NEW_TOKENS=512
TEMPERATURE=0.7

# API 서버 설정
API_HOST=0.0.0.0
API_PORT=8000
```

## 9. 오류 처리 및 디버깅

### 9.1 공통 오류 코드

| 오류 코드 | 설명 | 해결 방법 |
|----------|------|----------|
| `CONNECTION_ERROR` | 네트워크 연결 실패 | PC IP 주소 확인, 방화벽 설정 확인 |
| `TIMEOUT_ERROR` | 요청 타임아웃 | `API_TIMEOUT` 값 증가, 네트워크 상태 확인 |
| `MODEL_NOT_LOADED` | 모델 미로드 | PC에서 모델 로드 확인 |
| `INVALID_PROMPT` | 잘못된 프롬프트 | 프롬프트 형식 확인 |
| `DB_CONNECTION_ERROR` | DB 연결 실패 | DB 서버 상태, 연결 정보 확인 |

### 9.2 로깅 설정

**공통 로깅 형식**:
```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)
```

### 9.3 디버깅 체크리스트

**네트워크 연결**:
- [ ] PC와 노트북이 같은 로컬 네트워크에 연결되어 있는가?
- [ ] IP 주소가 올바른가?
- [ ] 방화벽이 포트를 차단하지 않는가?

**API 서버**:
- [ ] PC에서 API 서버가 실행 중인가?
- [ ] `/api/health` 엔드포인트가 응답하는가?
- [ ] 모델이 정상적으로 로드되었는가?

**DB 연결**:
- [ ] 노트북에서 PostgreSQL이 실행 중인가?
- [ ] Docker 컨테이너가 정상적으로 실행 중인가?
- [ ] DB 연결 정보가 올바른가?

## 10. 버전 관리

### 10.1 Git 설정

**공통 `.gitignore`**:
```
# 환경 변수 파일
.env

# 로그 파일
*.log

# Python 캐시
__pycache__/
*.pyc

# 가상환경
.venv/
venv/

# 모델 파일
models/
*.safetensors
```

### 10.2 공통 파일 동기화

노트북과 PC 간에 다음 파일들을 동기화해야 합니다:
- `config.py`
- `.env.example`
- `requirements.txt`
- `공용_작업_가이드.md`

**주의**: `.env` 파일은 각 시스템에서 개별적으로 생성하고 Git에 커밋하지 않습니다.

## 11. 테스트 시나리오

### 11.1 기본 통신 테스트

1. **PC에서 API 서버 시작**:
   ```bash
   python model_api_server.py
   ```

2. **노트북에서 서버 상태 확인**:
   ```bash
   curl http://{PC_IP}:8000/api/health
   ```

3. **노트북에서 프롬프트 전송 테스트**:
   ```bash
   curl -X POST http://{PC_IP}:8000/api/generate \
     -H "Content-Type: application/json" \
     -d '{"prompt": "안녕하세요"}'
   ```

### 11.2 전체 파이프라인 테스트

1. **노트북에서 DB 연결 확인**
2. **노트북에서 프롬프트 생성**
3. **노트북에서 PC로 프롬프트 전송**
4. **PC에서 모델 실행 및 답변 생성**
5. **노트북에서 답변 수신 및 처리**

## 12. 참고 사항

### 12.1 보안 고려사항

- `.env` 파일에 민감한 정보(DB 비밀번호 등) 저장 시 Git에 커밋하지 않기
- 로컬 네트워크에서만 접근 가능하도록 방화벽 설정
- 외부 IP 접근 시 추가 보안 조치 필요

### 12.2 성능 최적화

- 모델은 PC에서 한 번만 로드하여 메모리에 유지
- 요청 타임아웃 설정으로 무한 대기 방지
- 네트워크 지연 최소화를 위한 로컬 네트워크 사용

### 12.3 확장 가능성

- 향후 여러 PC에서 모델 서버 실행 가능하도록 설계
- 로드 밸런싱 고려 (선택사항)
- 모니터링 및 로깅 시스템 추가 (선택사항)

